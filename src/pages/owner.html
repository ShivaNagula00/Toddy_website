<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard - Toddy Orders</title>
    <link rel="icon" type="image/svg+xml" href="../assets/favicon.svg">
    <link rel="icon" type="image/png" href="../assets/favicon.png">
    <link rel="apple-touch-icon" href="../assets/favicon.png">
    <link rel="stylesheet" href="../styles/style.css">
    <style>
        .owner-header {
            background: #1b5e20;
            color: white;
            padding: 20px;
            text-align: center;
            margin: -10px -10px 20px -10px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 2px solid #2e7d32;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #2e7d32;
        }
        .orders-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
        }
        .order-card {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .order-time {
            color: #6c757d;
            font-size: 0.9em;
        }
        .order-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: bold;
        }
        .status-new {
            background: #fff3cd;
            color: #856404;
        }
        .status-delivered {
            background: #d4edda;
            color: #155724;
        }
        .customer-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .order-details {
            background: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-danger { background: #dc3545; color: white; }
        .btn:hover { opacity: 0.8; }
        .no-orders {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }
        .filter-section {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-section select, .filter-section button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        @media (max-width: 768px) {
            .customer-info { grid-template-columns: 1fr; }
            .action-buttons { flex-direction: column; }
            .filter-section { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="owner-header">
        <h1>üè™ Owner Dashboard</h1>
        <p>Manage Toddy Orders & Deliveries</p>
    </div>

    <main>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div>Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="todayOrders">0</div>
                <div>Today's Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingDeliveries">0</div>
                <div>Pending Deliveries</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalRevenue">‚Çπ0</div>
                <div>Total Revenue</div>
            </div>
        </div>

        <div class="orders-container">
            <div class="filter-section">
                <select id="statusFilter">
                    <option value="all">All Orders</option>
                    <option value="new">New Orders</option>
                    <option value="delivered">Delivered</option>
                </select>
                <select id="typeFilter">
                    <option value="all">All Types</option>
                    <option value="delivery">Delivery Only</option>
                    <option value="pickup">Pickup Only</option>
                </select>
                <button onclick="refreshOrders()" class="btn btn-primary">üîÑ Refresh</button>
                <button onclick="showInventoryManager()" class="btn" style="background:#17a2b8;">üì¶ Manage Stock</button>
                <button onclick="showPricingManager()" class="btn" style="background:#28a745;">üí∞ Manage Prices</button>
                <button onclick="clearAllOrders()" class="btn btn-danger">üóëÔ∏è Clear All</button>
                <a href="orders-table.html" class="btn btn-warning">üìä Table View</a>
                <button onclick="logout()" class="btn" style="background:#dc3545;">üö™ Logout</button>
            </div>

            <h2>üìã Customer Orders</h2>
            <div id="ordersContainer">
                <div class="loading">
                    <h3>Loading orders...</h3>
                    <p>Please wait while we connect to the database</p>
                </div>
            </div>
        </div>
    </main>

    <!-- Inventory Manager Modal -->
    <div id="inventoryModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:8px;width:90%;max-width:500px;">
            <h3>üì¶ Manage Inventory</h3>
            <div style="margin:20px 0;">
                <label>Eetha Stock (Litres):</label>
                <input type="number" id="eethaStock" min="0" style="width:100%;padding:8px;margin:5px 0;">
            </div>
            <div style="margin:20px 0;">
                <label>Thati Stock (Litres):</label>
                <input type="number" id="thatiStock" min="0" style="width:100%;padding:8px;margin:5px 0;">
            </div>
            <div style="margin:20px 0;">
                <label>Neera Stock (Litres):</label>
                <input type="number" id="neeraStock" min="0" style="width:100%;padding:8px;margin:5px 0;">
            </div>
            <div style="text-align:center;margin-top:20px;">
                <button onclick="updateInventoryLevels()" class="btn btn-success">‚úì Update Stock</button>
                <button onclick="hideInventoryManager()" class="btn" style="background:#6c757d;margin-left:10px;">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <!-- Pricing Manager Modal -->
    <div id="pricingModal" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;">
        <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;padding:30px;border-radius:8px;width:90%;max-width:500px;">
            <h3>üí∞ Manage Prices</h3>
            <div style="margin:20px 0;">
                <label>Eetha Price (‚Çπ/Litre):</label>
                <input type="number" id="eethaPrice" min="1" style="width:100%;padding:8px;margin:5px 0;">
            </div>
            <div style="margin:20px 0;">
                <label>Thati Price (‚Çπ/Litre):</label>
                <input type="number" id="thatiPrice" min="1" style="width:100%;padding:8px;margin:5px 0;">
            </div>
            <div style="margin:20px 0;">
                <label>Neera Price (‚Çπ/Litre):</label>
                <input type="number" id="neeraPrice" min="1" style="width:100%;padding:8px;margin:5px 0;">
            </div>
            <div style="text-align:center;margin-top:20px;">
                <button onclick="updatePricingLevels()" class="btn btn-success">‚úì Update Prices</button>
                <button onclick="hidePricingManager()" class="btn" style="background:#6c757d;margin-left:10px;">‚úï Cancel</button>
            </div>
        </div>
    </div>

    <!-- Load Firebase -->
    <script src="../scripts/firebase.js" type="module"></script>

    <script>
        let ordersData = [];

        // Authentication check
        function checkOwnerAuth() {
            const isAuthenticated = localStorage.getItem('ownerAuth') === 'authenticated';
            const loginTime = parseInt(localStorage.getItem('ownerLoginTime') || '0');
            const currentTime = Date.now();
            const sessionDuration = 24 * 60 * 60 * 1000; // 24 hours
            
            if (isAuthenticated && (currentTime - loginTime <= sessionDuration)) {
                return true;
            }
            
            window.location.href = 'login.html';
            return false;
        }

        // Wait for Firebase to load
        function waitForFirebase() {
            return new Promise((resolve) => {
                const checkFirebase = () => {
                    if (window.firestore && window.firestore.getAllOrders) {
                        resolve();
                    } else {
                        setTimeout(checkFirebase, 100);
                    }
                };
                checkFirebase();
            });
        }

        // Load orders from Firestore
        async function loadOrders() {
            try {
                await waitForFirebase();
                
                const result = await window.firestore.getAllOrders();
                
                if (!result.success) {
                    throw new Error(result.error || 'Failed to load orders');
                }
                
                // Only show successful orders
                ordersData = result.orders.filter(order => order.paymentStatus === 'SUCCESS');
                
                displayOrders();
                updateStats();
                
            } catch (error) {
                console.error('Error loading orders:', error);
                document.getElementById('ordersContainer').innerHTML = `
                    <div class="no-orders">
                        <h3>Error Loading Orders</h3>
                        <p>${error.message}</p>
                        <button onclick="loadOrders()" class="btn btn-primary">Try Again</button>
                    </div>
                `;
            }
        }

        // Display orders
        function displayOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            let filteredOrders = ordersData;
            
            if (statusFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => (order.status || 'new') === statusFilter);
            }
            if (typeFilter !== 'all') {
                filteredOrders = filteredOrders.filter(order => order.deliveryType === typeFilter);
            }
            
            const container = document.getElementById('ordersContainer');
            
            if (filteredOrders.length === 0) {
                container.innerHTML = `
                    <div class="no-orders">
                        <h3>No orders found</h3>
                        <p>No orders match the current filter criteria</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filteredOrders.map(order => {
                const customer = order.customer || 'Unknown';
                const mobile = order.mobile || 'N/A';
                const orderType = order.items ? order.items[0].type : 'N/A';
                const quantity = order.items ? order.items[0].quantity : 'N/A';
                const total = order.totalAmount ? `‚Çπ${order.totalAmount}` : 'N/A';
                const timestamp = order.createdAt ? 
                    new Date(order.createdAt.seconds * 1000).toLocaleString() : 
                    'N/A';
                
                return `
                <div class="order-card">
                    <div class="order-header">
                        <div class="order-time">${timestamp}</div>
                        <div class="order-status status-${order.status || 'new'}">${(order.status || 'new').toUpperCase()}</div>
                    </div>
                    
                    <div class="customer-info">
                        <div><strong>üë§ Customer:</strong> ${customer}</div>
                        <div><strong>üì± Mobile:</strong> <a href="tel:${mobile}">${mobile}</a></div>
                    </div>
                    
                    <div class="order-details">
                        <div><strong>ü•• Product:</strong> ${orderType.toUpperCase()} - ${quantity}L</div>
                        <div><strong>üí∞ Total:</strong> ${total}</div>
                        <div><strong>üì¶ Type:</strong> ${order.deliveryType === 'delivery' ? 'üöö Home Delivery' : 'üè™ Self Pickup'}</div>
                        ${order.deliveryType === 'delivery' ? `
                            <div><strong>üìç Address:</strong> ${order.address || 'N/A'}</div>
                        ` : ''}
                    </div>
                    
                    <div class="action-buttons">
                        ${order.deliveryType === 'delivery' && order.mapsLink ? `
                            <a href="${order.mapsLink}" target="_blank" class="btn btn-primary">üó∫Ô∏è Directions</a>
                        ` : ''}
                        <a href="tel:${mobile}" class="btn btn-success">üìû Call</a>
                        <a href="https://wa.me/${mobile}" target="_blank" class="btn btn-warning">üí¨ WhatsApp</a>
                        <button onclick="markAsDelivered('${order.id}')" class="btn btn-success">‚úÖ Delivered</button>
                        <button onclick="deleteOrder('${order.id}')" class="btn btn-danger">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `}).join('');
        }

        // Update statistics
        function updateStats() {
            const today = new Date().toDateString();
            const todayOrders = ordersData.filter(order => {
                const orderDate = order.createdAt ? 
                    new Date(order.createdAt.seconds * 1000) : 
                    new Date();
                return orderDate.toDateString() === today;
            });
            
            const pendingDeliveries = ordersData.filter(order => 
                order.deliveryType === 'delivery' && (order.status || 'new') !== 'delivered'
            );
            
            const totalRevenue = ordersData.reduce((sum, order) => {
                return sum + (order.totalAmount || 0);
            }, 0);

            document.getElementById('totalOrders').textContent = ordersData.length;
            document.getElementById('todayOrders').textContent = todayOrders.length;
            document.getElementById('pendingDeliveries').textContent = pendingDeliveries.length;
            document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue}`;
        }

        // Mark order as delivered
        async function markAsDelivered(orderId) {
            try {
                await waitForFirebase();
                const result = await window.firestore.updateOrder(orderId, { 
                    status: 'delivered', 
                    deliveredAt: new Date().toISOString() 
                });
                
                if (result.success) {
                    await loadOrders();
                    alert('Order marked as delivered! ‚úÖ');
                } else {
                    alert('Failed to update order status');
                }
            } catch (error) {
                console.error('Error marking as delivered:', error);
                alert('Failed to update order status');
            }
        }

        // Delete single order
        async function deleteOrder(orderId) {
            if (!confirm('Are you sure you want to delete this order?')) return;
            
            try {
                await waitForFirebase();
                const result = await window.firestore.deleteOrder(orderId);
                
                if (result.success) {
                    await loadOrders();
                    alert('Order deleted successfully! üóëÔ∏è');
                } else {
                    alert('Failed to delete order: ' + result.error);
                }
            } catch (error) {
                console.error('Error deleting order:', error);
                alert('Failed to delete order');
            }
        }

        // Clear all orders
        async function clearAllOrders() {
            if (!confirm('Are you sure you want to delete ALL orders? This cannot be undone!')) return;
            
            try {
                await waitForFirebase();
                const result = await window.firestore.deleteAllOrders();
                
                if (result.success) {
                    await loadOrders();
                    alert(`${result.deletedCount || 0} orders deleted successfully! üóëÔ∏è`);
                } else {
                    alert('Failed to delete orders: ' + result.error);
                }
            } catch (error) {
                console.error('Error clearing orders:', error);
                alert('Failed to delete orders');
            }
        }

        // Refresh orders
        async function refreshOrders() {
            document.getElementById('ordersContainer').innerHTML = '<div class="loading"><h3>Refreshing...</h3></div>';
            await loadOrders();
            alert('Orders refreshed! üîÑ');
        }

        // Logout
        function logout() {
            localStorage.removeItem('ownerAuth');
            localStorage.removeItem('ownerLoginTime');
            window.location.href = 'login.html';
        }

        // ===== INVENTORY MANAGEMENT =====
        async function getInventory() {
            try {
                await waitForFirebase();
                const result = await window.firestore.getShopSettings();
                if (result.success && result.settings && result.settings.inventory) {
                    return result.settings.inventory;
                }
            } catch (error) {
                console.log('Using default inventory');
            }
            return {eetha: 50, thati: 50, neera: 50};
        }

        async function showInventoryManager() {
            const inventory = await getInventory();
            document.getElementById('eethaStock').value = inventory.eetha;
            document.getElementById('thatiStock').value = inventory.thati;
            document.getElementById('neeraStock').value = inventory.neera;
            document.getElementById('inventoryModal').style.display = 'block';
        }

        async function updateInventoryLevels() {
            try {
                const newInventory = {
                    eetha: parseInt(document.getElementById('eethaStock').value) || 0,
                    thati: parseInt(document.getElementById('thatiStock').value) || 0,
                    neera: parseInt(document.getElementById('neeraStock').value) || 0
                };
                
                await waitForFirebase();
                const result = await window.firestore.updateShopSettings({ inventory: newInventory });
                hideInventoryManager();
                
                if (result.success) {
                    alert('Inventory updated successfully! üì¶\nChanges will be visible on all devices.');
                } else {
                    alert('Failed to update inventory. Please try again.');
                }
            } catch (error) {
                console.error('Error updating inventory:', error);
                alert('Failed to update inventory.');
            }
        }

        function hideInventoryManager() {
            document.getElementById('inventoryModal').style.display = 'none';
        }

        // ===== PRICING MANAGEMENT =====
        async function getPrices() {
            try {
                await waitForFirebase();
                const result = await window.firestore.getShopSettings();
                if (result.success && result.settings && result.settings.prices) {
                    return result.settings.prices;
                }
            } catch (error) {
                console.log('Using default prices');
            }
            return {eetha: 60, thati: 75, neera: 90};
        }

        async function showPricingManager() {
            const prices = await getPrices();
            document.getElementById('eethaPrice').value = prices.eetha;
            document.getElementById('thatiPrice').value = prices.thati;
            document.getElementById('neeraPrice').value = prices.neera;
            document.getElementById('pricingModal').style.display = 'block';
        }

        async function updatePricingLevels() {
            try {
                const newPrices = {
                    eetha: parseInt(document.getElementById('eethaPrice').value) || 60,
                    thati: parseInt(document.getElementById('thatiPrice').value) || 75,
                    neera: parseInt(document.getElementById('neeraPrice').value) || 90
                };
                
                await waitForFirebase();
                const result = await window.firestore.updateShopSettings({ prices: newPrices });
                hidePricingManager();
                
                if (result.success) {
                    alert('Prices updated successfully! üí∞\n\nNew prices will be reflected on all devices immediately.');
                } else {
                    alert('Failed to update prices. Please try again.');
                }
            } catch (error) {
                console.error('Error updating prices:', error);
                alert('Failed to update prices.');
            }
        }

        function hidePricingManager() {
            document.getElementById('pricingModal').style.display = 'none';
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', displayOrders);
        document.getElementById('typeFilter').addEventListener('change', displayOrders);

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            if (checkOwnerAuth()) {
                loadOrders();
                // Auto-refresh every 30 seconds
                setInterval(loadOrders, 30000);
            }
        });
    </script>
</body>
</html>