<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Order Successful - Toddy Shop</title>
<link rel="stylesheet" href="css/style.css" />
<style>
.success-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px;background:#f8f9fa}
.success-card{background:#fff;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);text-align:center;max-width:500px;width:100%}
.success-icon{font-size:60px;color:#28a745;margin-bottom:20px}
.success-title{color:#28a745;font-size:28px;margin-bottom:15px}
.success-message{color:#6c757d;font-size:16px;line-height:1.6;margin-bottom:25px}
.order-info{background:#f8f9fa;padding:20px;border-radius:8px;margin:20px 0;text-align:left}
.back-btn{background:#007bff;color:#fff;padding:12px 30px;text-decoration:none;border-radius:6px;display:inline-block;margin-top:20px;transition:background 0.3s}
.back-btn:hover{background:#0056b3}
.error-card{background:#fff;padding:40px;border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.1);text-align:center;max-width:500px;width:100%}
.error-icon{font-size:60px;color:#dc3545;margin-bottom:20px}
.error-title{color:#dc3545;font-size:28px;margin-bottom:15px}
#shopMap{height:300px!important;width:100%!important;border-radius:8px;border:1px solid #ddd}
@media (max-width:768px){.success-card{padding:20px;margin:10px}#shopMap{height:250px!important}}
</style>
</head>
<body>
<div class="success-container" id="pageContent">
    <!-- Content will be loaded by JavaScript based on payment status -->
</div>

<!-- Load Firebase -->
<script src="js/firebase.js" type="module"></script>

<!-- Google Maps JavaScript API (Replace YOUR_API_KEY with actual key) -->
<!-- <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places" async defer></script> -->

<script>
// CRITICAL: Verify payment success before showing success page
async function verifyPaymentSuccess() {
    try {
        // Get recent orders from Firestore
        const result = await window.firestore.getAllOrders();
        
        if (!result.success) {
            showErrorPage();
            return;
        }
        
        // Check if there's a recent successful payment
        const recentSuccessfulOrder = result.orders.find(order => 
            order.paymentStatus === 'SUCCESS' && 
            order.paymentCompletedAt &&
            (Date.now() - new Date(order.paymentCompletedAt).getTime()) < 300000 // Within 5 minutes
        );
        
        if (recentSuccessfulOrder) {
            showSuccessPage(recentSuccessfulOrder);
        } else {
            showErrorPage();
        }
    } catch (error) {
        console.error('Error verifying payment:', error);
        showErrorPage();
    }
}

function showSuccessPage(order) {
    const orderType = order.items ? order.items[0].type : order.type;
    const quantity = order.items ? order.items[0].quantity : order.litres;
    const total = order.totalAmount ? `‚Çπ${order.totalAmount}` : order.total;
    const isPickup = order.deliveryType === 'pickup';
    
    // Shop location info for pickup orders
    const shopLocationHtml = isPickup ? `
        <div class="shop-location" style="background:#e8f5e8;padding:20px;border-radius:8px;margin:20px 0;border-left:4px solid #28a745">
            <h3 style="color:#28a745;margin-bottom:15px">üìç Shop Location for Pickup</h3>
            <p><strong>Address:</strong><br>${order.shopLocation?.address || 'JVRF+996 Kallu manduva kodimial, Sandralapally X Rd, Sandralapally, Telangana 505501'}</p>
            <div style="margin-top:15px">
                <a href="${order.shopLocation?.googleMapsUrl || 'https://www.google.com/maps?q=18.4319,78.4744'}" 
                   target="_blank" 
                   style="background:#4285f4;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;display:inline-block;margin-right:10px">
                   üó∫Ô∏è Open in Google Maps
                </a>
                <a href="tel:+916302564464" 
                   style="background:#28a745;color:white;padding:10px 20px;text-decoration:none;border-radius:5px;display:inline-block">
                   üìû Call Shop
                </a>
            </div>
        </div>
    ` : '';
    
    document.getElementById('pageContent').innerHTML = `
        <div class="success-card">
            <div class="success-icon">‚úÖ</div>
            <h1 class="success-title">Order Successful!</h1>
            <p class="success-message">
                We will get back to you shortly.
            </p>
            
            <div class="order-info">
                <h3>Order Details:</h3>
                <p><strong>Customer:</strong> ${order.customer}</p>
                <p><strong>Product:</strong> ${orderType.toUpperCase()} - ${quantity}L</p>
                <p><strong>Total:</strong> ${total}</p>
                <p><strong>Type:</strong> ${order.deliveryType === 'delivery' ? 'Home Delivery' : 'Self Pickup'}</p>
                ${order.deliveryType === 'delivery' && order.distance ? `<p><strong>Distance:</strong> ${order.distance} km</p>` : ''}
            </div>
            
            ${shopLocationHtml}
            
            ${isPickup ? `
                <div id="shopMapContainer" style="margin:20px 0;width:100%;overflow:hidden">
                    <h4 style="color:#28a745;margin-bottom:10px">üìç Shop Location Map</h4>
                    <div id="shopMap" style="height:300px;width:100%;border-radius:8px;border:1px solid #ddd"></div>
                    <p style="font-size:12px;color:#666;margin-top:5px;text-align:center">Tap map to open in Google Maps app</p>
                </div>
            ` : ''}
            
            <div class="order-info">
                <h3>What happens next?</h3>
                <ul>
                    <li>You will receive a confirmation call within 30 minutes</li>
                    ${isPickup ? 
                        '<li>Visit our shop at the address shown above to collect your order</li>' + 
                        '<li>Use Google Maps for easy navigation to our location</li>' :
                        '<li>For delivery orders, our team will coordinate timing</li>'
                    }
                    <li>Keep your phone handy for our call</li>
                </ul>
            </div>
            
            <a href="index.html" class="back-btn">Place Another Order</a>
        </div>
    `;
    
    // Initialize shop map for pickup orders (only if Google Maps is available)
    if (isPickup) {
        // Check if Google Maps API is loaded
        const checkGoogleMaps = () => {
            if (typeof google !== 'undefined' && google.maps) {
                // Google Maps is available - initialize map
                const shopLat = 18.64110;
                const shopLng = 78.87335;
                
                const mapOptions = {
                    zoom: 15,
                    center: { lat: shopLat, lng: shopLng },
                    // Mobile-friendly options
                    gestureHandling: 'cooperative',
                    zoomControl: true,
                    mapTypeControl: false,
                    scaleControl: false,
                    streetViewControl: false,
                    rotateControl: false,
                    fullscreenControl: true
                };
                
                const shopMap = new google.maps.Map(document.getElementById('shopMap'), mapOptions);
                
                new google.maps.Marker({
                    position: { lat: shopLat, lng: shopLng },
                    map: shopMap,
                    title: 'Toddy Shop - Pickup Location',
                    icon: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png'
                });
                
                // Add click listener to open in Google Maps app on mobile
                shopMap.addListener('click', () => {
                    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
                    if (isMobile) {
                        window.open(`https://www.google.com/maps?q=${shopLat},${shopLng}`, '_blank');
                    }
                });
            } else {
                // Google Maps not available - hide map container and show alternative
                const mapContainer = document.getElementById('shopMapContainer');
                if (mapContainer) {
                    mapContainer.innerHTML = `
                        <div style="background:#f8f9fa;padding:20px;border-radius:8px;text-align:center;border:1px solid #ddd">
                            <h4 style="color:#28a745;margin-bottom:15px">üìç Shop Location</h4>
                            <p style="margin-bottom:15px;color:#666">Map not available. Use the button below to open location in Google Maps.</p>
                            <a href="https://www.google.com/maps?q=18.64110,78.87335" 
                               target="_blank" 
                               style="background:#4285f4;color:white;padding:12px 24px;text-decoration:none;border-radius:6px;display:inline-block;font-weight:bold">
                               üó∫Ô∏è Open in Google Maps
                            </a>
                        </div>
                    `;
                }
            }
        };
        
        // Check immediately and after a delay for API loading
        setTimeout(checkGoogleMaps, 100);
        setTimeout(checkGoogleMaps, 1000);
        setTimeout(checkGoogleMaps, 3000);
    }
}

function showErrorPage() {
    document.getElementById('pageContent').innerHTML = `
        <div class="error-card">
            <div class="error-icon">‚ùå</div>
            <h1 class="error-title">Access Denied</h1>
            <p class="success-message">
                This page can only be accessed after a successful payment.
            </p>
            <a href="index.html" class="back-btn">Go to Order Page</a>
        </div>
    `;
}

// Wait for Firebase to load, then verify
window.addEventListener('load', () => {
    setTimeout(() => {
        if (window.firestore) {
            verifyPaymentSuccess();
        } else {
            showErrorPage();
        }
    }, 2000);
});
</script>
</body>
</html>